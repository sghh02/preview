import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:gap/gap.dart';
import 'package:go_router/go_router.dart';
import 'package:its_me/common_widgets/common_background.dart';
import 'package:its_me/constants/theme.dart';
import 'package:its_me/features/master_data/presentation/providers/master_data_providers.dart';
import 'package:its_me/features/values_assessment/presentation/providers/value_selection_provider.dart';

import '../../../../common_widgets/custom_header.dart';
import '../../../../constants/assets.dart';
import '../../../../constants/route_paths.dart';

class ValueRankingPage extends ConsumerStatefulWidget {
  const ValueRankingPage({super.key});

  @override
  ConsumerState<ValueRankingPage> createState() => _ValueRankingPageState();
}

class _ValueRankingPageState extends ConsumerState<ValueRankingPage> {
  List<RankedValue> _topValues = [];
  var _isInitialized = false;
  var _isLoading = true;

  @override
  void initState() {
    super.initState();
    _initializeTopValues();
  }

  Future<void> _initializeTopValues() async {
    setState(() {
      _isLoading = true;
    });

    try {
      // 選択された価値観を取得
      final selectedValues = ref.read(selectedValuesProvider);

      // 質問データを取得
      final questionsAsync = await ref.read(questionsProvider.future);
      final questions = questionsAsync;

      // 選択された価値観のうち、最高評価（0）のものを抽出
      final highRatedValues = <RankedValue>[];

      for (final entry in selectedValues.entries) {
        // 値が0（最高評価）の項目のみを追加
        if (entry.value == 0) {
          // 対応する質問を探す
          final matchingQuestions =
              questions.where((q) => q.id == entry.key).toList();
          final question =
              matchingQuestions.isNotEmpty ? matchingQuestions.first : null;

          if (question != null) {
            // 多言語対応
            final locale = Localizations.localeOf(context);
            final isJapanese = locale.languageCode == 'ja';

            highRatedValues.add(
              RankedValue(
                id: question.id,
                title: isJapanese ? question.question.ja : question.question.en,
                description:
                    isJapanese ? question.question.ja : question.question.en,
                rank: highRatedValues.length + 1,
              ),
            );
          }
        }
      }

      setState(() {
        _topValues = highRatedValues;

        // 先頭5つの項目IDをランキングプロバイダに初期値として設定
        final initialRanking =
            _topValues.take(5).map((value) => value.id).toList();
        ref.read(valueRankingProvider.notifier).state = initialRanking;

        _isInitialized = true;
        _isLoading = false;
      });
    } catch (e) {
      // エラーハンドリング
      setState(() {
        _isLoading = false;
      });

      if (mounted) {
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(SnackBar(content: Text('データの読み込みに失敗しました: $e')));
      }
    }
  }

  // ランキングの順番を入れ替える
  void _moveItem(int oldIndex, int newIndex) {
    setState(() {
      if (oldIndex < newIndex) {
        newIndex -= 1;
      }
      final item = _topValues.removeAt(oldIndex);
      _topValues.insert(newIndex, item);

      // ランクの再計算
      for (var i = 0; i < _topValues.length; i++) {
        _topValues[i].rank = i + 1;
      }

      // 上位5つのランキングをプロバイダーに保存
      final topRanked = _topValues.take(5).map((value) => value.id).toList();
      ref.read(valueRankingProvider.notifier).state = topRanked;

      // ローカルストレージにも保存
      _saveRankingToLocalStorage(topRanked);
    });
  }

  // ランキングをローカルストレージに保存
  Future<void> _saveRankingToLocalStorage(List<String> ranking) async {
    try {
      final answerStorage = ref.read(answerStorageProvider);
      await answerStorage.saveRanking(ranking);
    } catch (e) {
      // エラーハンドリング
      if (mounted) {
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(SnackBar(content: Text('ランキングの保存に失敗しました: $e')));
      }
    }
  }

  // 診断結果を計算して保存
  Future<void> _calculateAndSaveResult() async {
    try {
      final ranking = ref.read(valueRankingProvider);
      if (ranking.isEmpty) {
        throw Exception('価値観が選択されていません。少なくとも1つの価値観を選択してください。');
      }

      // 質問データからカテゴリーマップを作成
      final questionsAsync = await ref.read(questionsProvider.future);
      final questions = questionsAsync;

      final questionCategoryMap = <String, String>{};
      for (final question in questions) {
        questionCategoryMap[question.id] = question.categoryId;
      }

      // 診断結果を計算
      final calculator = ref.read(valueCalculatorProvider);
      final result = calculator.calculateResult(ranking, questionCategoryMap);

      // 結果をプロバイダーに保存
      ref.read(assessmentResultProvider.notifier).state = result;

      // ローカルストレージにも保存
      final answerStorage = ref.read(answerStorageProvider);
      await answerStorage.saveResult(result);

      return;
    } catch (e) {
      // エラーハンドリング
      if (mounted) {
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(SnackBar(content: Text('診断結果の計算に失敗しました: $e')));
      }
      rethrow;
    }
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return const CommonBackground(
        child: Scaffold(
          backgroundColor: Colors.transparent,
          appBar: CustomHeader(),
          body: Center(child: CircularProgressIndicator()),
        ),
      );
    }

    if (!_isInitialized) {
      return CommonBackground(
        child: Scaffold(
          backgroundColor: Colors.transparent,
          appBar: const CustomHeader(),
          body: Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Text('データの読み込みに失敗しました'),
                const SizedBox(height: 16),
                ElevatedButton(
                  onPressed: () => _initializeTopValues(),
                  child: const Text('再試行'),
                ),
              ],
            ),
          ),
        ),
      );
    }

    var rankingInstructions = '';
    if (_topValues.length == 1) {
      rankingInstructions = 'あなたの最も大事な価値観です。\n完了ボタンを押して診断結果を確認しましょう。';
    } else {
      rankingInstructions = '大事な価値観の中で1〜5位までを選びます。\n移動ボタン長押しでドラッグ操作できます。';
    }

    return CommonBackground(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: const CustomHeader(),
        body: SingleChildScrollView(
          child: Center(
            child: Container(
              constraints: const BoxConstraints(maxWidth: 460),
              child: Padding(
                padding: EdgeInsets.only(
                  left: MediaQuery.of(context).size.width <= 375 ? 12 : 16,
                  top: 20,
                  right: MediaQuery.of(context).size.width <= 375 ? 12 : 16,
                  bottom: 30,
                ),
                child: Column(
                  children: [
                    Image.asset(Assets.lamp, height: 40),
                    const Gap(8),
                    const Text(
                      '価値観ランキング',
                      style: TextStyle(
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const Gap(8),
                    Text(
                      rankingInstructions,
                      textAlign: TextAlign.center,
                      style: const TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const Gap(24),

                    // ドラッグ可能な価値観リスト
                    ReorderableListView.builder(
                      shrinkWrap: true,
                      physics: const NeverScrollableScrollPhysics(),
                      onReorder: _moveItem,
                      itemCount: _topValues.length,
                      itemBuilder: (context, index) {
                        return _buildRankingCard(
                          context,
                          _topValues[index],
                          Key('rank-${_topValues[index].rank}'),
                        );
                      },
                      buildDefaultDragHandles: false,
                      proxyDecorator: (child, index, animation) {
                        return AnimatedBuilder(
                          animation: animation,
                          builder: (BuildContext context, Widget? child) {
                            return Material(
                              color: Colors.transparent,
                              child: child,
                            );
                          },
                          child: child,
                        );
                      },
                    ),
                    const Gap(24),

                    // 完了ボタン
                    ElevatedButton(
                      onPressed: () async {
                        // 完了ボタンの処理
                        try {
                          // ローディング表示
                          setState(() {
                            _isLoading = true;
                          });

                          // 診断結果を計算して保存
                          await _calculateAndSaveResult();

                          // 結果ページへ遷移
                          if (mounted) {
                            context.go(
                              RoutePaths.firstPage,
                            ); // TODO: 結果表示ページへのパスに変更
                          }
                        } catch (e) {
                          setState(() {
                            _isLoading = false;
                          });
                          // エラーは_calculateAndSaveResult内で処理済み
                        }
                      },
                      style: ElevatedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 12),
                      ),
                      child: const Text('完了！診断結果へ　▶︎'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  // ランキングカードウィジェット
  Widget _buildRankingCard(BuildContext context, RankedValue value, Key key) {
    // ランクに応じた色
    Color rankColor;
    if (value.rank == 1) {
      rankColor = const Color(0xFFF0C653); // ゴールド
    } else if (value.rank == 2) {
      rankColor = const Color(0xFFA9C7C9); // シルバー
    } else if (value.rank == 3) {
      rankColor = const Color(0xFFB59C82); // ブロンズ
    } else if (value.rank == 4) {
      rankColor = const Color(0xFFF497B7); // ピンク
    } else if (value.rank == 5) {
      rankColor = const Color(0xFF87C6ED); // 水色
    } else {
      rankColor = AppColors.ratingMidColor; // グレー
    }

    return Card(
      key: key,
      margin: const EdgeInsets.only(bottom: 8),
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 8),
        child: Row(
          children: [
            // ランク番号表示
            Container(
              width: 40,
              height: 40,
              decoration: BoxDecoration(
                color: rankColor,
                shape: BoxShape.circle,
              ),
              alignment: Alignment.center,
              child: Text(
                value.rank.toString(),
                style: const TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                  height: 1,
                  leadingDistribution: TextLeadingDistribution.even,
                ),
                textAlign: TextAlign.center,
              ),
            ),
            const Gap(12),
            // 価値観タイトル
            Expanded(
              child: Text(
                value.title,
                style: const TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
            // 操作ボタン
            DecoratedBox(
              decoration: BoxDecoration(
                border: Border.all(color: Colors.black12),
                borderRadius: BorderRadius.circular(4),
              ),
              child: Column(
                children: [
                  GestureDetector(
                    onTap:
                        value.rank == 1
                            ? null
                            : () => _moveItem(value.rank - 1, 0),
                    child: Container(
                      padding: const EdgeInsets.symmetric(horizontal: 4),
                      child: Column(
                        children: [
                          const Gap(4),
                          Image.asset(
                            Assets.arrowGoTop,
                            height: 16,
                            color:
                                value.rank == 1
                                    ? Colors.grey.withAlpha((0.5 * 255).round())
                                    : AppColors.blackColor,
                          ),
                          Text(
                            '1位へ',
                            style: TextStyle(
                              fontSize: 10,
                              color:
                                  value.rank == 1
                                      ? Colors.grey.withAlpha(
                                        (0.5 * 255).round(),
                                      )
                                      : AppColors.mainTextColor,
                            ),
                          ),
                          const Gap(4),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
            const Gap(8),
            // 移動ボタン
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 4),
              decoration: BoxDecoration(
                border: Border.all(color: Colors.black12),
                borderRadius: BorderRadius.circular(4),
              ),
              child: ReorderableDragStartListener(
                index: value.rank - 1,
                child: Column(
                  children: [
                    const Gap(4),
                    Image.asset(Assets.arrowMove, height: 16),
                    const Text('移動', style: TextStyle(fontSize: 10)),
                    const Gap(4),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// 価値観ランキングデータクラス
class RankedValue {
  final String id;
  final String title;
  final String description;
  int rank;

  RankedValue({
    required this.id,
    required this.title,
    required this.description,
    required this.rank,
  });
}
